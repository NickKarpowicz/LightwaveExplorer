cmake_minimum_required(VERSION 3.16)
project(LightwaveExplorer LANGUAGES CXX CUDA)

set(CMAKE_CXX_COMPILER "icpx")
include_directories(../dlib ../LightwaveExplorer ${MKLROOT}/include/fftw)
find_package(CUDA REQUIRED)
find_package(CUDAToolkit)

set(CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS}; -gencode=arch=compute_75,code=\"sm_75,compute_75\" -O3 -D NOCUDAMAIN)
cuda_compile(LightwaveExplorerCudaObjects LightwaveExplorerCore.cu)
include_directories(${CUDA_INCLUDE_DIRS})
link_directories(${CUDA_LIBRARY_DIRS})
link_directories(${CUDATookit_LIBRARY_DIRS})
find_package(PkgConfig REQUIRED)
pkg_check_modules(GTK4 REQUIRED gtk4)
pkg_check_modules(FFTW REQUIRED fftw3)

include_directories(${FFTW_INCLUDE_DIRS})
link_directories(${FFTW_LIBRARY_DIRS})
find_package(IntelDPCPP)
include_directories(${GTK4_INCLUDE_DIRS})
link_directories(${GTK4_LIBRARY_DIRS})
find_package(fmt)

add_compile_options(-std=c++20 -O3 -fopenmp -fsycl -w)
add_executable(LightwaveExplorer ${LightwaveExplorerCudaObjects} LightwaveExplorerGTK/LightwaveExplorerDPCPPlib.cpp LightwaveExplorerGTK/LightwaveExplorerFrontendGTK.cpp LightwaveExplorerUtilities.cpp LightwaveExplorerCoreCPU.cpp DlibLibraryComponents/DlibLibraryComponents.cpp)
target_link_libraries(LightwaveExplorer ${GTK4_LIBRARIES} ${FFTW_LIBRARIES} ${CUDA_LIBRARIES} ${CUDAToolkit_LIBRARIES})
target_link_libraries(LightwaveExplorer fmt::fmt)
target_link_libraries(LightwaveExplorer -lcufft -lnvidia-ml)
target_link_libraries(LightwaveExplorer
    ${MKLROOT}/lib/intel64/libmkl_sycl.a 
    -Wl,--start-group 
    ${MKLROOT}/lib/intel64/libmkl_intel_ilp64.a 
    ${MKLROOT}/lib/intel64/libmkl_tbb_thread.a 
    ${MKLROOT}/lib/intel64/libmkl_core.a 
    -Wl,--end-group
    -liomp5
    -ltbb
    -lsycl
    -lOpenCL
)
